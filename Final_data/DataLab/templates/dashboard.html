{% extends "base.html" %}

{% block title %}Dashboard - DataLab{% endblock %}

{% block head %}
<!-- Custom CSS -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
<!-- Add AI assistant CSS -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/ai_assistant.css') }}">
{% endblock %}

{% block content %}
<div class="container">
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="sidebar-header">
      <i class="fas fa-chart-line"></i>
      <h2>DataLab</h2>
    </div>
    <ul class="nav-menu">
      <li class="nav-item active">
        <a href="#"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
      </li>
      <li class="nav-item">
        <a href="#"><i class="fas fa-table"></i> Data Explorer</a>
      </li>
      <li class="nav-item">
        <a href="#" id="visualizationsNavLink"><i class="fas fa-chart-bar"></i> Visualizations</a>
      </li>
      <li class="nav-item">
        <a href="#"><i class="fas fa-cogs"></i> Data Processing</a>
      </li>
      <li class="nav-item">
        <a href="/ml"><i class="fas fa-brain"></i> ML Model Selection</a>
      </li>
      <li class="nav-item">
        <a href="/ml/jupyterlite" target="_blank"><i class="fas fa-code"></i> Python Notebook</a>
      </li>
      <li class="nav-item">
        <a href="{{ url_for('ai_assistant_page') }}"><i class="fas fa-robot"></i> AI Assistant</a>
      </li>
      <li class="nav-item">
        <a href="{{ url_for('logout') }}"><i class="fas fa-sign-out-alt"></i> Logout</a>
      </li>
    </ul>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <div class="header">
      <div class="header-title">
        <h1>Welcome, {{ username }}</h1>
        <p>Here's an overview of your data</p>
      </div>
      <div class="theme-selector">
        <label for="theme">Theme</label>
        <select id="theme">
          <option value="light">Light</option>
          <option value="dark">Dark</option>
        </select>
      </div>
    </div>

    <div class="dashboard-content">
      <!-- File Upload Section -->
      <div class="upload-section" id="uploadArea">
        <h3>Upload a new dataset</h3>
        <div class="file-upload">
          <button class="file-upload-btn">
            <i class="fas fa-cloud-upload-alt"></i> Choose File
          </button>
          <input type="file" class="file-upload-input" id="fileInput">
        </div>
        <p class="supported-formats">Supported formats: CSV, JSON, Excel, Text</p>
        <div id="uploadProgress" class="progress d-none mt-3">
          <div id="uploadProgressBar" class="progress-bar" role="progressbar" style="width: 0%;"
               aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
        </div>
        <div id="uploadMessage" class="alert mt-3 d-none"></div>
      </div>



      <!-- Data Preview Section -->
      <div class="data-preview">
        <div class="section-header">
          <h3>My Datasets</h3>
          <div class="section-controls">
            <input type="text" id="datasetSearch" placeholder="Search datasets..." class="form-control form-control-sm">
          </div>
        </div>

        {% if datasets|length > 0 %}
        <div class="row" id="datasetsContainer">
          {% for dataset in datasets %}
          <div class="col-md-6 col-lg-4 mb-4 dataset-item">
            <div class="card dataset-card h-100" data-id="{{ dataset.id }}">
              <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0 text-truncate" title="{{ dataset.name }}">
                  {% if dataset.file_type == 'csv' %}
                    <i class="fas fa-file-csv text-success me-2"></i>
                  {% elif dataset.file_type == 'json' %}
                    <i class="fas fa-file-code text-warning me-2"></i>
                  {% elif dataset.file_type in ['xlsx', 'xls'] %}
                    <i class="fas fa-file-excel text-primary me-2"></i>
                  {% else %}
                    <i class="fas fa-file-alt text-secondary me-2"></i>
                  {% endif %}
                  {{ dataset.name }}
                </h6>
                <div class="dropdown">
                  <button class="btn btn-sm btn-light" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="fas fa-ellipsis-v"></i>
                  </button>
                  <!-- In the dropdown menu for each dataset card -->
                  <ul class="dropdown-menu dropdown-menu-end">
                    <li><a class="dropdown-item" href="{{ url_for('data_preview', dataset_id=dataset.id) }}"><i class="fas fa-eye me-2"></i>Preview</a></li>
                    <li><a class="dropdown-item" href="{{ url_for('data_quality', dataset_id=dataset.id) }}"><i class="fas fa-check-circle me-2"></i>Quality</a></li>
                    <li><a class="dropdown-item" href="{{ url_for('summary_statistics', dataset_id=dataset.id) }}"><i class="fas fa-chart-pie me-2"></i>Statistics</a></li>
                    <li><a class="dropdown-item" href="{{ url_for('visualization', dataset_id=dataset.id) }}"><i class="fas fa-chart-bar me-2"></i>Visualize</a></li>
                    <li><a class="dropdown-item" href="{{ url_for('preprocessing_page', dataset_id=dataset.id) }}"><i class="fas fa-cogs me-2"></i>Preprocess</a></li>
                    <li><a class="dropdown-item" href="/ml/{{ dataset.id }}"><i class="fas fa-brain me-2"></i>ML Selection</a></li>
                    <li><a class="dropdown-item" href="/workflow/{{ dataset.id }}"><i class="fas fa-project-diagram me-2"></i>Workflow</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item analyze-with-ai" href="#" data-id="{{ dataset.id }}" data-name="{{ dataset.name }}"><i class="fas fa-robot me-2"></i>Analyze with AI</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item text-danger delete-dataset" href="#" data-id="{{ dataset.id }}"><i class="fas fa-trash-alt me-2"></i>Delete</a></li>
                  </ul>
                </div>
              </div>
              <div class="card-body">
                <div class="mb-3">
                  <div class="d-flex justify-content-between mb-1">
                    <span>Quality Score</span>
                    <span class="fw-bold">{{ dataset.quality_score }}%</span>
                  </div>
                  <div class="quality-indicator">
                    <div class="quality-bar" style="width: {{ dataset.quality_score }}%;
                      background-color:
                        {% if dataset.quality_score >= 80 %}#28a745
                        {% elif dataset.quality_score >= 60 %}#ffc107
                        {% else %}#dc3545
                        {% endif %};">
                    </div>
                  </div>
                </div>
                <div class="row g-3 text-muted">
                  <div class="col-6">
                    <div><i class="fas fa-table me-1"></i> Rows</div>
                    <div class="fw-bold">{{ dataset.rows }}</div>
                  </div>
                  <div class="col-6">
                    <div><i class="fas fa-columns me-1"></i> Columns</div>
                    <div class="fw-bold">{{ dataset.columns }}</div>
                  </div>
                  <div class="col-12">
                    <div><i class="fas fa-calendar-alt me-1"></i> Created</div>
                    <div class="fw-bold">{{ dataset.created_at }}</div>
                  </div>
                </div>
                {% if dataset.ai_insights %}
                <div class="mt-3">
                  <div class="ai-insights-preview">
                    <div><i class="fas fa-robot me-1 text-primary"></i> AI Insights</div>
                    <div class="text-muted small">{{ dataset.ai_insights|truncate(100) }}</div>
                    <button class="btn btn-sm btn-outline-primary mt-2 view-ai-insights" data-id="{{ dataset.id }}">
                      View Full Insights
                    </button>
                  </div>
                </div>
                {% endif %}
              </div>
              <div class="card-footer bg-transparent">
                <div class="d-grid gap-2">
                  <a href="{{ url_for('visualization', dataset_id=dataset.id) }}" class="btn btn-primary btn-sm">
                    <i class="fas fa-chart-bar me-1"></i>Visualize
                  </a>
                  <a href="{{ url_for('data_preview', dataset_id=dataset.id) }}" class="btn btn-outline-secondary btn-sm">Analyze</a>
                </div>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
        {% else %}
        <div class="empty-state">
          <i class="fas fa-database fa-4x text-muted mb-3"></i>
          <h4>No datasets yet</h4>
          <p class="text-muted">Upload your first dataset to get started</p>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Delete Dataset Confirmation Modal -->
<div class="modal fade" id="deleteDatasetModal" tabindex="-1" aria-labelledby="deleteDatasetModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteDatasetModalLabel">Confirm Delete</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        Are you sure you want to delete this dataset? This action cannot be undone.
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmDelete">Delete</button>
      </div>
    </div>
  </div>
</div>

<!-- AI Insights Modal -->
<div class="modal fade" id="aiInsightsModal" tabindex="-1" aria-labelledby="aiInsightsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="aiInsightsModalLabel">AI Insights</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="aiInsightsContent" class="ai-insights-content"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" id="askMoreAI">Ask AI More</button>
      </div>
    </div>
  </div>
</div>

<!-- AI Assistant Button and Panel -->
<div id="aiAssistantButton" class="ai-assistant-button">
  <i class="fas fa-robot"></i>
</div>

<div id="aiAssistantPanel" class="ai-assistant-panel">
  <div class="assistant-header">
    <h3><i class="fas fa-robot"></i> AI Assistant</h3>
    <button id="closeAssistant" class="close-btn">
      <i class="fas fa-times"></i>
    </button>
  </div>
  <div id="assistantChatHistory" class="assistant-chat-history">
    <!-- Chat messages will be added here by JavaScript -->
  </div>
  <div id="assistantLoading" class="assistant-loading d-none">
    <div class="spinner"></div>
  </div>
  <div class="assistant-input">
    <textarea id="assistantMessage" placeholder="Ask about your data..."></textarea>
    <button id="sendAssistantMessage">
      <i class="fas fa-paper-plane"></i>
    </button>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
<!-- Add AI assistant JavaScript -->
<script src="{{ url_for('static', filename='js/ai_assistant.js') }}"></script>
<script>
  // AI Insights handler
  document.addEventListener('DOMContentLoaded', function() {
    // Handle view AI insights buttons
    const viewInsightsButtons = document.querySelectorAll('.view-ai-insights');
    const aiInsightsModal = document.getElementById('aiInsightsModal');
    const aiInsightsContent = document.getElementById('aiInsightsContent');
    const askMoreAIButton = document.getElementById('askMoreAI');

    viewInsightsButtons.forEach(button => {
      button.addEventListener('click', function() {
        const datasetId = this.getAttribute('data-id');
        const datasetCard = document.querySelector(`.dataset-card[data-id="${datasetId}"]`);
        const datasetName = datasetCard.querySelector('.card-header h6').textContent.trim();

        // Find AI insights from the page
        const aiInsightsPreview = this.closest('.ai-insights-preview');
        const aiInsightsText = aiInsightsPreview.querySelector('.text-muted').textContent;

        // Update modal content
        document.getElementById('aiInsightsModalLabel').textContent = `AI Insights for ${datasetName}`;

        // Format insights with proper paragraphs and highlighting
        let formattedInsights = aiInsightsText
          .replace(/\n\n/g, '</p><p>')
          .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
          .replace(/\*(.*?)\*/g, '<em>$1</em>');

        aiInsightsContent.innerHTML = `<p>${formattedInsights}</p>`;

        // Set dataset ID for Ask More button
        askMoreAIButton.setAttribute('data-id', datasetId);
        askMoreAIButton.setAttribute('data-name', datasetName);

        // Show modal
        const modal = new bootstrap.Modal(aiInsightsModal);
        modal.show();
      });
    });

    // Handle "Ask AI More" button
    if (askMoreAIButton) {
      askMoreAIButton.addEventListener('click', function() {
        const datasetId = this.getAttribute('data-id');
        const datasetName = this.getAttribute('data-name');

        // Close modal
        const modal = bootstrap.Modal.getInstance(aiInsightsModal);
        if (modal) modal.hide();

        // Open AI assistant with prompt
        askAIAboutDataset(datasetId, datasetName, 'Tell me more about the dataset "{dataset}" and what preprocessing steps would you recommend?');
      });
    }
  });
</script>
{% endblock %}