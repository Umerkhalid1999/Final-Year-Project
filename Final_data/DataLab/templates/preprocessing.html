{% extends "base.html" %}

{% block title %}Data Preprocessing - DataLab{% endblock %}

<!-- Line ~9: Add this after existing script tags in the head block -->
{% block head %}
<!-- Custom CSS for preprocessing page -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/preprocessing.css') }}">
<!-- Chart.js for visualizations -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Add this line for Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %}

{% block content %}
<div class="container preprocessing-container" data-id="{{ dataset.id }}">
  <div class="row">
    <div class="col-md-12">
      <h2>Data Preprocessing: {{ dataset.name }}</h2>
      <p class="text-muted">Configure and apply data transformations</p>
      
      <div class="card mb-4">
        <div class="card-header">
          <h5>Dataset Overview</h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <table class="table table-sm">
                <tr>
                  <th>File Name:</th>
                  <td>{{ dataset.name }}</td>
                </tr>
                <tr>
                  <th>File Type:</th>
                  <td>{{ dataset.file_type }}</td>
                </tr>
                <tr>
                  <th>Rows:</th>
                  <td>{{ dataset.rows }}</td>
                </tr>
                <tr>
                  <th>Columns:</th>
                  <td>{{ dataset.columns }}</td>
                </tr>
                <tr>
                  <th>Quality Score:</th>
                  <td>
                    <div class="progress" style="height: 20px;">
                      <div class="progress-bar 
                        {% if dataset.quality_score >= 80 %}bg-success
                        {% elif dataset.quality_score >= 60 %}bg-warning
                        {% else %}bg-danger
                        {% endif %}" 
                        role="progressbar" 
                        style="width: {{ dataset.quality_score }}%;" 
                        aria-valuenow="{{ dataset.quality_score }}" 
                        aria-valuemin="0" 
                        aria-valuemax="100">
                        {{ dataset.quality_score }}%
                      </div>
                    </div>
                  </td>
                </tr>
              </table>
            </div>
            <div class="col-md-6">
              <div class="sample-data-container">
                <h6>Sample Data</h6>
                <div class="table-responsive">
                  <table class="table table-sm table-bordered">
                    <thead>
                      <tr>
                        {% for col in columns %}
                        <th>{{ col.name }}</th>
                        {% endfor %}
                      </tr>
                    </thead>
                    <tbody>
                      {% for row in sample_data %}
                      <tr>
                        {% for col in columns %}
                        <td>{{ row[col.name] }}</td>
                        {% endfor %}
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="card mb-4">
        <div class="card-header">
          <h5>Preprocessing Configuration</h5>
        </div>
        <div class="card-body">
          <form id="preprocessingConfigForm">
            <div class="row mb-3">
              <div class="col-md-6">
                <label for="taskType" class="form-label">Machine Learning Task Type</label>
                <select class="form-select" id="taskType" name="task_type" required>
                  <option value="classification">Classification</option>
                  <option value="regression">Regression</option>
                  <option value="clustering">Clustering</option>
                </select>
              </div>
              <div class="col-md-6">
                <label for="targetColumn" class="form-label">Target Column (if supervised)</label>
                <select class="form-select" id="targetColumn" name="target" disabled>
                  <option value="">-- Select Target --</option>
                  {% for col in columns %}
                  <option value="{{ col.name }}">{{ col.name }} ({{ col.type }})</option>
                  {% endfor %}
                </select>
              </div>
            </div>
            
            <div class="row mb-3">
              <div class="col-md-12">
                <button type="button" id="analyzeBtn" class="btn btn-primary">
                  <i class="fas fa-search me-2"></i>Analyze Dataset
                </button>
              </div>
            </div>
          </form>
        </div>
      </div>
      
      <div id="analysisResults" class="d-none">
        <div class="card mb-4">
          <div class="card-header">
            <h5>Data Analysis Results</h5>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                <h6>Data Quality Issues</h6>
                <div id="qualityIssues" class="list-group mb-3"></div>
              </div>
              <div class="col-md-6">
                <h6>Suggested Transformations</h6>
                <div id="suggestedTransformations" class="list-group mb-3"></div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="card mb-4">
          <div class="card-header">
            <h5>Transformation Pipeline</h5>
          </div>
          <div class="card-body">
            <div id="transformationPipeline" class="pipeline-steps"></div>
            
            <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-3">
              <button id="addCustomTransformBtn" class="btn btn-outline-secondary me-md-2">
                <i class="fas fa-plus me-2"></i>Add Custom Step
              </button>
              <button id="previewTransformBtn" class="btn btn-outline-primary me-md-2">
                <i class="fas fa-eye me-2"></i>Preview Transformations
              </button>
              <button id="applyTransformBtn" class="btn btn-success">
                <i class="fas fa-magic me-2"></i>Apply Transformations
              </button>
            </div>
          </div>
        </div>
      </div>
      
      <div id="transformationPreview" class="card mb-4 d-none">
        <div class="card-header">
          <h5>Transformation Preview</h5>
        </div>
        <div class="card-body">
          <div id="transformationStepsPreview"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Transformation Step Modal -->
<div class="modal fade" id="transformStepModal" tabindex="-1" aria-labelledby="transformStepModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="transformStepModalLabel">Add Custom Transformation</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="customTransformForm">
          <div class="mb-3">
            <label for="transformType" class="form-label">Transformation Type</label>
            <select class="form-select" id="transformType" name="type" required>
              <option value="">-- Select Type --</option>
              <option value="imputation">Missing Value Imputation</option>
              <option value="scaling">Feature Scaling</option>
              <option value="encoding">Categorical Encoding</option>
              <option value="outlier">Outlier Treatment</option>
              <option value="transformation">Numerical Transformation</option>
            </select>
          </div>
          
          <div class="mb-3">
            <label for="transformColumns" class="form-label">Columns to Transform</label>
            <select class="form-select" id="transformColumns" name="columns" multiple required></select>
          </div>
          
          <div id="transformParamsContainer">
            <!-- Dynamic parameters will be added here based on transform type -->
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" id="saveTransformBtn" class="btn btn-primary">Save Transformation</button>
      </div>
    </div>
  </div>
</div>

<!-- Transformation Visualization Modal -->
<div class="modal fade" id="transformVizModal" tabindex="-1" aria-labelledby="transformVizModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="transformVizModalLabel">Transformation Effect</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-md-6">
            <h6>Before Transformation</h6>
            <div id="beforeTransformStats"></div>
          </div>
          <div class="col-md-6">
            <h6>After Transformation</h6>
            <div id="afterTransformStats"></div>
          </div>
        </div>
        <div class="row mt-3">
          <div class="col-md-12">
            <h6>Visual Comparison</h6>
            <canvas id="transformComparisonChart"></canvas>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/preprocessing.js') }}"></script>
<!-- Line ~418: Replace everything inside the script tags -->
<script>
  // Initialize with dataset ID
  const datasetId = {{ dataset.id }};

  // Make dataset info globally available to preprocessing.js
  window.currentDatasetId = {{ dataset.id }};
  window.datasetColumns = [{% for col in columns %}'{{ col.name }}',{% endfor %}];

  document.addEventListener('DOMContentLoaded', function() {
    console.log('HTML script loaded', window.currentDatasetId, window.datasetColumns);

    // Task type change handler
    document.getElementById('taskType').addEventListener('change', function() {
      const targetSelect = document.getElementById('targetColumn');
      if (this.value === 'classification' || this.value === 'regression') {
        targetSelect.disabled = false;
        targetSelect.required = true;
      } else {
        targetSelect.disabled = true;
        targetSelect.required = false;
        targetSelect.value = '';
      }
    });

    // Analyze button click handler
    document.getElementById('analyzeBtn').addEventListener('click', function() {
      analyzeDataset();
    });
  });

  function analyzeDataset() {
    const form = document.getElementById('preprocessingConfigForm');
    const formData = new FormData(form);
    const config = Object.fromEntries(formData.entries());

    // Show loading state
    const analyzeBtn = document.getElementById('analyzeBtn');
    analyzeBtn.disabled = true;
    analyzeBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Analyzing...';

    // Call API to analyze dataset
    fetch(`/api/preprocessing/analyze/${datasetId}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(config)
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        displayAnalysisResults(data.analysis, data.suggestions);
        document.getElementById('analysisResults').classList.remove('d-none');
      } else {
        alert(data.message || 'Error analyzing dataset');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Error analyzing dataset');
    })
    .finally(() => {
      analyzeBtn.disabled = false;
      analyzeBtn.innerHTML = '<i class="fas fa-search me-2"></i>Analyze Dataset';
    });
  }

  function displayAnalysisResults(analysis, suggestions) {
    // Display quality issues
    const qualityIssuesContainer = document.getElementById('qualityIssues');
    qualityIssuesContainer.innerHTML = '';

    // Missing values
    const missingCols = Object.entries(analysis.missing_values)
      .filter(([col, count]) => count > 0)
      .map(([col, count]) => col);

    if (missingCols.length > 0) {
      const item = document.createElement('div');
      item.className = 'list-group-item list-group-item-danger';
      item.innerHTML = `
        <div class="d-flex w-100 justify-content-between">
          <h6 class="mb-1">Missing Values</h6>
          <small>${missingCols.length} columns</small>
        </div>
        <p class="mb-1">Columns: ${missingCols.join(', ')}</p>
      `;
      qualityIssuesContainer.appendChild(item);
    }

    // Outliers (from suggestions)
    const outlierSuggestions = suggestions.filter(s => s.type === 'outlier');
    if (outlierSuggestions.length > 0) {
      const item = document.createElement('div');
      item.className = 'list-group-item list-group-item-warning';

      const outlierCols = outlierSuggestions.flatMap(s => s.columns);
      const totalOutliers = outlierSuggestions.reduce((sum, s) => sum + parseInt(s.description.split(' ')[0]), 0);

      item.innerHTML = `
        <div class="d-flex w-100 justify-content-between">
          <h6 class="mb-1">Outliers Detected</h6>
          <small>${totalOutliers} total</small>
        </div>
        <p class="mb-1">Columns: ${outlierCols.join(', ')}</p>
      `;
      qualityIssuesContainer.appendChild(item);
    }

    // Display suggested transformations
    const suggestionsContainer = document.getElementById('suggestedTransformations');
    suggestionsContainer.innerHTML = '';

    suggestions.forEach(suggestion => {
      const item = document.createElement('div');
      item.className = 'list-group-item list-group-item-action';
      item.innerHTML = `
        <div class="d-flex w-100 justify-content-between">
          <h6 class="mb-1 text-capitalize">${suggestion.type}</h6>
          <small class="text-muted">${suggestion.columns.length} cols</small>
        </div>
        <p class="mb-1">${suggestion.description}</p>
        <small class="text-muted">${suggestion.recommendation}</small>
        <div class="mt-2">
          <button class="btn btn-sm btn-outline-primary add-suggestion-btn"
                  data-type="${suggestion.type}"
                  data-columns='${JSON.stringify(suggestion.columns)}'>
            <i class="fas fa-plus me-1"></i>Add to Pipeline
          </button>
        </div>
      `;
      suggestionsContainer.appendChild(item);
    });
  }
</script>
{% endblock %}