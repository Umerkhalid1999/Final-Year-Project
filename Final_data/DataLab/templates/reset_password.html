document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('resetPasswordForm');
    const newPasswordInput = document.getElementById('new_password');
    const confirmPasswordInput = document.getElementById('confirm_password');
    const errorAlert = document.getElementById('errorAlert');

    // Validation function
    function validatePasswords() {
        let isValid = true;

        // Check new password length
        if (newPasswordInput.value.length < 8) {
            newPasswordInput.classList.add('is-invalid');
            isValid = false;
        } else {
            newPasswordInput.classList.remove('is-invalid');
        }

        // Check confirm password
        if (confirmPasswordInput.value.length < 8 ||
            newPasswordInput.value !== confirmPasswordInput.value) {
            confirmPasswordInput.classList.add('is-invalid');
            isValid = false;
        } else {
            confirmPasswordInput.classList.remove('is-invalid');
        }

        return isValid;
    }

    // Real-time validation
    [newPasswordInput, confirmPasswordInput].forEach(input => {
        input.addEventListener('input', validatePasswords);
    });

    // Form submission
    form.addEventListener('submit', function(e) {
        e.preventDefault();

        // Clear previous messages
        errorAlert.classList.add('d-none');
        errorAlert.textContent = '';
        errorAlert.classList.remove('alert-danger', 'alert-success');

        // Validate inputs
        if (!validatePasswords()) {
            return;
        }

        // Get the password reset code from the URL
        const urlParams = new URLSearchParams(window.location.search);
        const oobCode = urlParams.get('oobCode');

        if (!oobCode) {
            errorAlert.textContent = 'Invalid or expired reset link.';
            errorAlert.classList.remove('d-none');
            errorAlert.classList.add('alert-danger');
            return;
        }

        // Get Firebase auth from the global variable
        const auth = window.firebaseAuth.auth;
        const newPassword = newPasswordInput.value;

        window.firebaseAuth.confirmPasswordReset(auth, oobCode, newPassword)
            .then(() => {
                // Success
                errorAlert.textContent = 'Password has been reset successfully.';
                errorAlert.classList.remove('d-none');
                errorAlert.classList.add('alert-success');

                // Redirect to login after a delay
                setTimeout(() => {
                    window.location.href = "/login";
                }, 2000);
            })
            .catch((error) => {
                // Handle errors
                let errorMessage = 'An error occurred.';
                switch(error.code) {
                    case 'auth/invalid-action-code':
                        errorMessage = 'Invalid or expired reset link.';
                        break;
                    case 'auth/weak-password':
                        errorMessage = 'Password is too weak. Please choose a stronger password.';
                        break;
                    default:
                        errorMessage = error.message;
                }

                errorAlert.textContent = errorMessage;
                errorAlert.classList.remove('d-none');
                errorAlert.classList.add('alert-danger');
            });
    });
});